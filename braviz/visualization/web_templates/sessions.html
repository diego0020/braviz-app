<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Braviz Analysis History</title>
    <link rel="shortcut icon" href="{{ static_url ('favicon.png') }}"/>
    <link href="{{ static_url('bootstrap-3.3.4/css/bootstrap.min.css') }}" rel="stylesheet">
    <style type="text/css">
        div.debug {
        display:none;
        }

        div.event_date {
          font-weight: bold;
          min-width: 10ex;
        }

        div.session div.header{
          position:relative;
        }

        div.date-block {
            position: absolute;
            top: 2ex;
            right: 3ex;
        }

        .session h2{
          margin-bottom: 1em;
        }

        #session-to-delete{
            font-style: italic;
        }


    </style>
</head>
<body>

<div class="container">
<header>
    <img src="{{ static_url ('Logo_Braviz_h.png')}}" class="img-responsive">
</header>
    <h1>Analysis History</h1>
    <div class="debug">{{sessions}}</div>
    <div class="sessions_list" id="sessions_list">

    </div>
</div>

<div class="confirm-delete modal fade" tabindex="-1" role="dialog" id="confirm-session-delete">
    <div class="modal-dialog">
        <div class="modal-content">
                 <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Confirm delete session</h4>
                </div>
                <div class="modal-body">
                <p>Are you sure you want to delete all data from session <span id="session-to-delete"></span>, and all its
                    associated events? </p>
                    <p>This can't be undone.</p>
                </div>
                <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger cancel-button" data-dismiss="modal">Delete Session</button>
              </div>
        </div>
    </div>

</div>

<script src="{{ static_url ('jquery-2.1.3.min.js') }}"></script>
<script src="{{ static_url ('bootstrap-3.3.4/js/bootstrap.min.js') }}"></script>
<script type="text/javascript" src="{{ static_url ('d3/d3.js') }}"></script>

<script type="text/javascript">

var sessions_list;

function load_events(d,i,button){
    var parent=d3.select($(button).parents(".session")[0]);
parent.select("button.load-details").on("click",function(d,i){
  parent.select("div.events-list").remove();
parent.select(".load-details").on("click",function(d,i){load_events(d,i,button);})
  .text("Show details");
}).text("Hide details");

d3.json("history/data/events?session="+d.id,
  function(error,data){
    parent.append("div").attr("class","events-list panel-body")
    .selectAll("div.event").data(data["events"])
    .enter().append("div").attr("class","event clearfix").call(function(d,i){
        var ev=this;
        ev.append("div").attr("class","event_date pull-left")
          .attr("title",function(d){return d.full_date;})
          .text(function(d){ return d.abv_date;});
        ev.append("div").attr("class","event_text pull-left")
          .text(function(d){return d.name;});
      });
  });
}

function rename_session(d,i, button){
  var session=d3.select($(button).parents(".session")[0]);
  var title = session.select("h2");
  var rename_button = session.select("button.rename-session");
  rename_button.attr("disabled","disabled");
  var initial_title = title.text();
  title.text("");
  var form=title.append("form").attr("class","form-inline")
    .on("submit",function(){d3.event.preventDefault(); return false;});
  form.append("input").attr("value",initial_title).attr("class","form-control");

  form.append("button").attr("class","btn btn-default form-control")
    .text("Save").on("click",function(d,i){
      var new_text=form.select("input").node().value;
      d3.xhr("history/data/session")
              .header("Content-Type", "application/x-www-form-urlencoded")
              .post(
              "session="+ d.id+"&name="+new_text,
              function(error, reply){
                  form.remove();
                  if (reply.status == 202){
                      title.text(new_text);
                      d.name = new_text;
                  }
                  else{
                      title.text(initial_title);
                  }
      });
      rename_button.attr("disabled",null);
    });

  form.append("button").attr("class","btn btn-danger form-control")
    .text("Cancel").on("click",function(d,i){
      form.remove();
      title.text(initial_title);
      rename_button.attr("disabled",null);
    });
}

var confirm_session_delete;
$(function(){
    $("#confirm-session-delete button.cancel-button").on("click",function(e){
        confirm_session_delete = true;
    });
});
function delete_session(d,i,button){
    var session=d3.select($(button).parents(".session")[0]);
    // show confirmation
    confirm_session_delete = false;
    $("#session-to-delete").text(d.name);
    $("#confirm-session-delete").on("hidden.bs.modal", function(e){
        // delete in server
        if (confirm_session_delete){
            // delete in interface
            var s_id = d.id;
            console.log(d);
            console.log("deleting session");
            d3.xhr("history/data/session").header("Content-Type", "application/x-www-form-urlencoded")
                    .post("session="+s_id+"&delete=true",function(e,response){
                        if (response.status == 202){
                            var orig_data = sessions_list.data();
                            var j = orig_data.findIndex(function(e){return e.id == s_id});
                            orig_data.splice(j,1);
                            sessions_list.data(orig_data,key).exit().remove();
                        }
                    });
        }
        else{
            console.log("canceled");
        }
    });
    $("#confirm-session-delete").modal();
}

function key(d){
    return d.id;
}

function start(){

    var sessions = {% raw sessions %};
    sessions_list = d3.select("#sessions_list").selectAll("div.session").data(sessions,key).enter().append("div")
        .attr("class","session panel panel-default");;

    var s = sessions_list.append("div").attr("class","header panel-heading");
    s.append("h2").text(function(d){return d.name});

    var date_block = s.append("div").attr("class","date-block pull-right");
    date_block.append("div").attr("class","date").attr("title",function(d){return d.full_start})
        .text(function(d){return d.abv_start});
    date_block.append("div").attr("class","duration").text(function(d){return d.duration+" minutes"});

    var controls = s.append("div").attr("class","session-controls-wrapper clearfix")
    .append("div").attr("class","session-controls btn-group btn-group-lg btn-group-justified");

    controls.append("div").attr("class","btn-group")
      .append("button").attr("class","btn btn-default load-details").text("Show details")
      .on("click",function(d,i){load_events(d,i,this);});
    controls.append("div").attr("class","btn-group")
      .append("button").attr("class","btn btn-default rename-session").text("Rename")
      .on("click",function(d,i){rename_session(d,i,this);});
    controls.append("div").attr("class","btn-group")
      .append("button").attr("class","btn btn-danger delete-session").text("Delete")
      .on("click",function(d,i){delete_session(d,i,this);});

    d3.select("#sessions_list div.session button.delete-session").attr("disabled","disabled");
}

start();

</script>
</body>
</html>
