<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Braviz Slice Viewer</title>
    <link rel="shortcut icon" href="{{ static_url ('favicon.png') }}"/>
    <link href="{{ static_url('bootstrap-3.3.4/css/bootstrap.min.css') }}" rel="stylesheet">
    <style>
        div.slice-img{
            display: inline-block;
            margin: 0.5em;
        }
        div.slice-img img{
            width: 20em;
        }
        div.controls{
            margin: 3em;
        }
        #samples-list{
            max-height:50vh;
            overflow-y: auto;
        }

        #samples-list label{
            width:100%;
        }
    </style>


</head>
<body>
<div class="container-fluid">
<h1 class="text-center">
Braviz Slice Viewer
</h1>
<div class="controls row">
<div class="col-sm-6 col-sm-offset-3">
<form class="form-horizontal" action="javascript:void(0);">
  <div class="form-group">
    <label for="sample-select" class="control-label col-sm-3">Sample: </label>
      <div class="col-sm-6">
            <input type="text" readonly class="form-control" id="sample-select" placeholder="<All>">
      </div>
    <div class="col-sm-3">
        <input type="button" class="btn btn-default form-control" value="Load" data-toggle="modal"
        data-target="#samples-modal">
    </div>
  </div>

  <div class="form-group">
    <label for="sort-select" class="control-label col-sm-3">Sort Variable: </label>
      <div class="col-sm-6">
            <input type="text" readonly class="form-control" id="sort-select" placeholder="<None>">
      </div>
    <div class="col-sm-3">
        <input type="button" class="btn btn-default form-control" value="Select">
    </div>
  </div>

  <div class="form-group">
    <label for="image-select" class="control-label col-sm-3">Image: </label>
      <div class="col-sm-9">
        <select class="form-control" id="image-select" name="image-select" >
            {% for img in images %}
            <option value="{{ img[0] }}">{{ escape(img[1]) }}</option>
            {% end %}
        </select>
      </div>
  </div>

  <div class="form-group">
    <label for="coordinates-select" class="control-label col-sm-3">Coordinates: </label>
      <div class="col-sm-9">
        <select class="form-control" id="coordinates-select" name="orientation-select">
            <option value="subject">Subject</option>
            <option value="talairach" selected>Talairach</option>
            <option value="dartel">Dartel</option>
        </select>
      </div>
  </div>

  <div class="form-group">
    <label for="orientation-select" class="control-label col-sm-3">Orientation: </label>
      <div class="col-sm-9">
        <select class="form-control" id="orientation-select" name="orientation-select">
            <option value="axial">Axial</option>
            <option value="coronal">Coronal</option>
            <option value="sagital">Sagital</option>
        </select>
      </div>
  </div>

  <div class="form-group">
    <label for="slice-select" class="control-label col-sm-3">Slice</label>
      <div class="col-sm-9">
            <input type="number" class="form-control" id="slice-select" value="40">
      </div>
  </div>
<div class="col-sm-9 col-sm-offset-3">
    <button type="submit" class="btn btn-success form-control" id="load-slices-btn">Load Slices</button>
</div>

</form>
</div>
</div>
<div id="slices-panel" class="row"> </div>
</div>

<!-- Modal -->
<div class="modal fade" id="samples-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Load a Sample</h4>
      </div>
      <div class="modal-body">
        <form id="samples-list" class="well">

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="set-sample-btn">Select</button>
      </div>
    </div>
  </div>
</div>



<script src="{{ static_url ('jquery-2.1.3.min.js') }}"></script>
<script src="{{ static_url ('bootstrap-3.3.4/js/bootstrap.min.js') }}"></script>
<script type="text/javascript" src="{{ static_url ('d3/d3.js') }}"></script>
<script>
    var slices_panel = d3.select("#slices-panel");
    var sample_id = null;
    var sort_variable_id = null;
    var variable_id = null;

    function update_slices(sample, image_type, image_name, orientation, coordinates, slice){
        var slices = slices_panel.selectAll("div.slice-img").data(sample);
        slices.enter().append("div").attr("class","slice-img")
            .append("img").attr("class","img-responsive").attr("alt",function(d,i){return "Subject"+d;})
            .attr("title",function(d,i){return "Subject"+d;});
        slices.exit().remove();
        slices.each(function(d,i){
            var img = d3.select(this).select("img");
            var img_url = "slices/data/img?subj="+d;
            img_url += "&slice="+slice;
            img_url += "&orientation="+orientation;
            img_url += "&coordinates="+coordinates;
            img_url += "&type="+image_type;
            img_url += "&name="+image_name;
            img.attr("src",img_url);
        });
        slices.order();
    };

    function form_submitted(){
        var slice = $("#slice-select").val();
        var orientation = $("#orientation-select").val();
        var coordinates = $("#coordinates-select").val();
        var image_full = $("#image-select").val().split("/");
        var image_type = image_full[0];
        var image_name = image_full[1];
        var url = "slices/data/subjects?";
        if (sample_id != null){
            url+="sample="+sample_id;
            if (variable_id != null){
                url+="&";
            }
        }
        if (variable_id != null){
            url+="variable="+variable_id;
        }
        d3.json(url,function(error, response_data){
            if (error){
                alert("please check ir server is running");
            }
            else{
                sample = response_data["sample"];
                update_slices(sample, image_type, image_name, orientation, coordinates, slice);
            }
        });

    };

    function update_samples_list(){

        d3.json("slices/data/samples",function(error, data){
            if (error){
                alert("Error loading samples, check if server is running");
                return;
            }
            var samples = [];
            var keys=Object.keys(data["sample_name"]);
            keys.forEach(function(e){
                var s = Object();
                s.name = data["sample_name"][e];
                s.index = e;
                s.desc = data["sample_desc"][e];
                s.size = data["sample_size"][e];
                samples.push(s);
            });
        var sample_divs=d3.select("#samples-list").selectAll("div.radio").data(samples);
        sample_divs.enter().append("div").attr("class","radio")
            .attr("title",function(d){return d["desc"];})
            .append("label").call(function(l){
                l.append("input").attr({"type":"radio", "name":"sample"})
                .attr("value",function(d){return d.index;})
                l.append("p").text(function(d){return d.name + " ("+d.size+")"})
            });
        sample_divs.exit().remove();
        });
    }

    function load_variable(){

    }

    d3.select("#set-sample-btn").on("click",function(){
        var selected_sample = $("#samples-list input:checked");
        sample_id = selected_sample.val();
        var sample_name = $("#samples-list input:checked").next().text();
        $("#sample-select").attr("value",sample_name);
        $("#samples-modal").modal("hide");
    });
    $("#samples-modal").on("show.bs.modal",update_samples_list);



    d3.select("#load-slices-btn").on("click",form_submitted);

</script>
</body>
</html>